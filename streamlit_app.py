import math
import streamlit as st

st.set_page_config(page_title="–ü—Ä–æ–≥–Ω–æ–∑ —Å–µ—Ä–æ–º—ã –ø–æ—Å–ª–µ –ª–∞–ø–∞—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–æ–π –≥–µ—Ä–Ω–∏–æ–ø–ª–∞—Å—Ç–∏–∫–∏",
                   page_icon="ü©∫", layout="centered")

# -------------------------------------------------
# –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –º–æ–¥–µ–ª–∏ (–¢–∞–±–ª–∏—Ü–∞ 9)
# –§–æ—Ä–º—É–ª–∞: p = 1 / (1 + exp(-(b0 + Œ£ b_i¬∑x_i)))
# -------------------------------------------------
B0 = 1.669                        # –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞
B_SURG_TYPE = -0.975             # –¢–∏–ø –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞: 1 = TAPP, 0 = eTEP
B_PRIOR_HERNIA = 2.018            # –ì—Ä—ã–∂–µ—Å–µ—á–µ–Ω–∏–µ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ: 1 = –¥–∞, 0 = –Ω–µ—Ç
B_ASA = -1.418                    # ASA (1‚Äì4), –∫–∞–∫ —á–∏—Å–ª–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
B_BMI = -0.007                    # –ò–ú–¢ (—á–∏—Å–ª–æ)

# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≤ —Ç–∞–±–ª–∏—Ü–µ Exp(B) –¥–ª—è ¬´–¢–∏–ø –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞¬ª = 0.377.
# –ï—Å–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ Exp(B), —Ç–æ b ‚âà ln(0.377) = -0.976 (–∞ –Ω–µ -0.0975).
# –Ø –æ—Å—Ç–∞–≤–∏–ª —Ä–æ–≤–Ω–æ -0.0975 –∫–∞–∫ –≤ –≤–∞—à–µ–º —Å–∫—Ä–∏–Ω–µ. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ -0.976.


def sigmoid(z: float) -> float:
    # –ß–∏—Å–ª–µ–Ω–Ω–æ —É—Å—Ç–æ–π—á–∏–≤–∞—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    if z >= 0:
        ez = math.exp(-z)
        return 1.0 / (1.0 + ez)
    ez = math.exp(z)
    return ez / (1.0 + ez)


def predict_probability(surg_type_tapp: int, prior_hernia: int, asa: float, bmi: float) -> float:
    # z = b0 + b1*x1 + ...; –≥–¥–µ x1.. ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
    z = (
        B0
        + B_SURG_TYPE * int(surg_type_tapp)
        + B_PRIOR_HERNIA * int(prior_hernia)
        + B_ASA * float(asa)
        + B_BMI * float(bmi)
    )
    return sigmoid(z)


def risk_class(prob: float) -> str:
    if prob < 0.10:
        return "–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫"
    if prob <= 0.50:
        return "–£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫"
    return "–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫"


# ---------------- UI ----------------
st.title("–ü—Ä–æ–≥–Ω–æ–∑ —Ä–∏—Å–∫–∞ —Å–µ—Ä–æ–º—ã –ø–æ—Å–ª–µ –ª–∞–ø–∞—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–æ–π –≥–µ—Ä–Ω–∏–æ–ø–ª–∞—Å—Ç–∏–∫–∏")

col1, col2 = st.columns(2)
with col1:
    surgery = st.selectbox(
        "–¢–∏–ø –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (–∫–æ–¥–∏—Ä–æ–≤–∫–∞: 1 = TAPP, 0 = eTEP)",
        options=["eTEP (0)", "TAPP (1)"],
        index=0
    )
    surg_type_tapp = 1 if "TAPP" in surgery else 0

    prior_hernia = st.checkbox("–ì—Ä—ã–∂–µ—Å–µ—á–µ–Ω–∏–µ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ (1 = –¥–∞)", value=False)

with col2:
    asa = st.number_input("ASA (1‚Äì4)", min_value=1.0, max_value=4.0, step=1.0, value=2.0, format="%.0f")
    bmi = st.number_input("–ò–ú–¢, –∫–≥/–º¬≤", min_value=10.0, max_value=70.0, step=0.1, value=26.0)

# –ê–≤—Ç–æ–ø–µ—Ä–µ—Å—á—ë—Ç –±–µ–∑ –∫–Ω–æ–ø–∫–∏
p = predict_probability(
    surg_type_tapp=surg_type_tapp,
    prior_hernia=1 if prior_hernia else 0,
    asa=asa,
    bmi=bmi
)

st.write("---")
c1, c2 = st.columns(2)
c1.metric("–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–µ—Ä–æ–º—ã", f"{p*100:.1f}%")
cls = risk_class(p)
c2.metric("–ö–ª–∞—Å—Å —Ä–∏—Å–∫–∞", cls)

# –¶–≤–µ—Ç–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
if p < 0.10:
    st.success("–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ (< 10%)")
elif p <= 0.50:
    st.warning("–£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ (10‚Äì50%)")
else:
    st.error("–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ (> 50%)")

st.caption("–ú–æ–¥–µ–ª—å –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏: p = 1 / (1 + exp(-(b0 + Œ£ b_i¬∑x_i))). "
           "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ü–µ–ª–µ–π –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ.")
