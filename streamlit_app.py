# app.py
import math
import streamlit as st

st.set_page_config(
    page_title="–ü—Ä–æ–≥–Ω–æ–∑ –æ—Å–ª–æ–∂–Ω–µ–Ω–∏–π –ø–æ—Å–ª–µ –ª–∞–ø–∞—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–æ–π –≥–µ—Ä–Ω–∏–æ–ø–ª–∞—Å—Ç–∏–∫–∏",
    page_icon="ü©∫",
    layout="centered"
)

# ------------ —É—Ç–∏–ª–∏—Ç—ã ------------
def sigmoid(z: float) -> float:
    """–ß–∏—Å–ª–µ–Ω–Ω–æ —É—Å—Ç–æ–π—á–∏–≤–∞—è —Å–∏–≥–º–æ–∏–¥–∞."""
    if z >= 0:
        ez = math.exp(-z)
        return 1.0 / (1.0 + ez)
    ez = math.exp(z)
    return ez / (1.0 + ez)


def risk_class_from_prob(prob: float) -> str:
    """–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∏—Å–∫–∞ –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–∏)."""
    if prob < 0.10:
        return "–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫"
    if prob <= 0.50:
        return "–£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫"
    return "–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫"


st.title("–ü—Ä–æ–≥–Ω–æ–∑ –æ—Å–ª–æ–∂–Ω–µ–Ω–∏–π –ø–æ—Å–ª–µ –ª–∞–ø–∞—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–æ–π –≥–µ—Ä–Ω–∏–æ–ø–ª–∞—Å—Ç–∏–∫–∏")

tabs = st.tabs(["–°–µ—Ä–æ–º–∞", "–ë–æ–ª—å"])


# ======================================================================
# ===========================  –°–ï–†–û–ú–ê  =================================
# ======================================================================
with tabs[0]:
    st.subheader("–†–∏—Å–∫ —Å–µ—Ä–æ–º—ã")

    st.markdown(
        "–ú–æ–¥–µ–ª—å –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –º–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è) "
        "–≤ –≤—ã–±–æ—Ä–∫–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ —Å –ª–∞–ø–∞—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–æ–π –≥–µ—Ä–Ω–∏–æ–ø–ª–∞—Å—Ç–∏–∫–æ–π. "
           )

    # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –¥–ª—è —Å–µ—Ä–æ–º—ã (—Ç–∞–±–ª. 9)
    # –ü—Ä–µ–¥–∏–∫—Ç–æ—Ä—ã: —Ç–∏–ø –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (TAPP/eTEP), –≥—Ä—ã–∂–µ—Å–µ—á–µ–Ω–∏–µ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ, –∫–ª–∞—Å—Å ASA
    # –í–∞–∂–Ω–æ: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏ eTEP; –≤ UI TAPP=1, eTEP=0 ‚Üí –≤–Ω—É—Ç—Ä–∏ eTEP = 1 ‚àí TAPP.
    B0_S = 1.669
    B_SURG_TYPE_S = -0.975       # –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è I(eTEP)
    B_PRIOR_HERNIA_S = 2.018     # 1 = –¥–∞, 0 = –Ω–µ—Ç
    B_ASA_S = -1.418             # ASA –∫–∞–∫ 1..4

    def predict_seroma_probability(e_tep: int, prior_hernia: int, asa: int) -> float:
        """
        –†–∞—Å—á—ë—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Å–µ—Ä–æ–º—ã –ø–æ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏.
        e_tep: –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä eTEP (1=eTEP, 0=TAPP)
        prior_hernia: –≥—Ä—ã–∂–µ—Å–µ—á–µ–Ω–∏–µ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ (1/0)
        asa: –∫–ª–∞—Å—Å ASA (1..4)
        """
        z = (
            B0_S
            + B_SURG_TYPE_S * int(e_tep)
            + B_PRIOR_HERNIA_S * int(prior_hernia)
            + B_ASA_S * int(asa)
        )
        return sigmoid(z)

    col1, col2 = st.columns(2)

    with col1:
        surg_label_s = st.selectbox(
            "–¢–∏–ø –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞",
            options=["TAPP", "eTEP"],
            key="s_surg"
        )
        tapp_indicator_s = 1 if surg_label_s == "TAPP" else 0
        etep_indicator_s = 1 - tapp_indicator_s  # –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä eTEP

        prior_hernia_s = st.checkbox(
            "–ì—Ä—ã–∂–µ—Å–µ—á–µ–Ω–∏–µ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ",
            value=False,
            key="s_prior_hernia"
        )

    with col2:
        asa_label_s = st.selectbox(
            "ASA (–∫–ª–∞—Å—Å)",
            options=["I", "II", "III", "IV"],
            index=1,
            key="s_asa"
        )
        asa_s = ["I", "II", "III", "IV"].index(asa_label_s) + 1

    # –†–∞—Å—á—ë—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏)
    p_seroma = predict_seroma_probability(
        e_tep=etep_indicator_s,
        prior_hernia=1 if prior_hernia_s else 0,
        asa=asa_s
    )
    risk_cat_seroma = risk_class_from_prob(p_seroma)

    st.write("---")
    st.markdown(f"**–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∏—Å–∫–∞ —Å–µ—Ä–æ–º—ã:** {risk_cat_seroma}")

    if risk_cat_seroma == "–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫":
        st.success("–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ä–æ–º—ã –≤ —Ä–∞–Ω–Ω–µ–º –ø–æ—Å–ª–µ–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ.")
    elif risk_cat_seroma == "–£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫":
        st.warning("–£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ —Å–µ—Ä–æ–º—ã. –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ.")
    else:
        st.error("–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Å–µ—Ä–æ–º—ã. –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞.")

    st.info(
        "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω **–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π**. "
        "–ù–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –∏–∑–¥–µ–ª–∏–µ–º –∏ –Ω–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π. "
        "–í–Ω–µ—à–Ω—è—è –∫–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏/–∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ "
        "–Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–π –≤—ã–±–æ—Ä–∫–µ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∏—Å—å."
    )


# ======================================================================
# =========================  –ë–û–õ–¨ (—à–∫–∞–ª–∞)  ==============================
# ======================================================================
with tabs[1]:
    st.subheader("–†–∏—Å–∫ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–π –ø–æ—Å–ª–µ–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –±–æ–ª–∏ (–±–∞–ª–ª—å–Ω–∞—è —à–∫–∞–ª–∞)")

    st.markdown(
        "–ë–∞–ª–ª—å–Ω–∞—è —à–∫–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–¥–Ω–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (—à–∫–∞–ª–∞ –í–ê–®) –∏ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã—Ö "
        "—Ñ–∞–∫—Ç–æ—Ä–æ–≤: –º–µ—Ç–æ–¥–∞ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞, —Å–ø–æ—Å–æ–±–∞ —Ñ–∏–∫—Å–∞—Ü–∏–∏ –∏–º–ø–ª–∞–Ω—Ç–∞—Ç–∞, –ò–ú–¢ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ—Å—Ç–∏ –≥—Ä—ã–∂–∏. "
            )

    # –ë–∞–ª–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (–ø—Ä–∏–º–µ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø—Ä–∞–≤–∏—Ç—å –≤–µ—Å–∞):
    # - TAPP: +2 –±–∞–ª–ª–∞ (–ø–æ –¥–∞–Ω–Ω—ã–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ä–∞–Ω–Ω—è—è –±–æ–ª—å –≤—ã—à–µ, —á–µ–º –ø—Ä–∏ eTEP)
    # - eTEP: 0 –±–∞–ª–ª–æ–≤
    #
    # - –§–∏–∫—Å–∞—Ü–∏—è —Å—Ç–µ–ø–ª–µ—Ä–æ–º: +2 –±–∞–ª–ª–∞ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±–æ–ª—å)
    # - –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è: +1 –±–∞–ª–ª
    # - –ö–ª–µ–π: 0 –±–∞–ª–ª–æ–≤ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –±–æ–ª—å)
    #
    # - –ò–ú–¢ >= 30 –∫–≥/–º¬≤: +1 –±–∞–ª–ª
    #
    # - –ì—Ä—ã–∂–µ—Å–µ—á–µ–Ω–∏–µ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ (—Ä–µ—Ü–∏–¥–∏–≤): +1 –±–∞–ª–ª

    def pain_risk_score(
        surg_type: str,
        fix_type: str,
        bmi: float,
        prior_hernia: bool
    ) -> int:
        score = 0

        # –¢–∏–ø –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
        if surg_type == "TAPP":
            score += 2   # –±–æ–ª—å—à–µ —Ç—Ä–∞–≤–º–∞—Ç–∏–∑–∞—Ü–∏—è –±—Ä—é—à–∏–Ω—ã, –≤—ã—à–µ –í–ê–® –Ω–∞ 1-–µ —Å—É—Ç–∫–∏
        else:
            score += 0   # eTEP

        # –°–ø–æ—Å–æ–± —Ñ–∏–∫—Å–∞—Ü–∏–∏
        if fix_type == "–ì–µ—Ä–Ω–∏–æ—Å—Ç–µ–ø–ª–µ—Ä":
            score += 2
        elif fix_type == "–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π":
            score += 1
        else:  # "–ö–ª–µ–π"
            score += 0

        # –ò–ú–¢
        if bmi >= 30.0:
            score += 1

        # –†–µ—Ü–∏–¥–∏–≤–Ω–∞—è –≥—Ä—ã–∂–∞ / –≥—Ä—ã–∂–µ—Å–µ—á–µ–Ω–∏–µ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ
        if prior_hernia:
            score += 1

        return score

    def pain_risk_category(score: int) -> str:
        """
        –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è —Å—É–º–º–∞—Ä–Ω–æ–≥–æ –±–∞–ª–ª–∞:
        0‚Äì1 –±–∞–ª–ª  ‚Üí –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–π –±–æ–ª–∏
        2‚Äì3 –±–∞–ª–ª–∞ ‚Üí —É–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫
        ‚â•4 –±–∞–ª–ª–æ–≤ ‚Üí –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫
        """
        if score <= 1:
            return "–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫"
        if score <= 3:
            return "–£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫"
        return "–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫"

    c1, c2 = st.columns(2)

    with c1:
        surg_label_p = st.selectbox(
            "–¢–∏–ø –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞",
            options=["TAPP", "eTEP"],
            key="p_surg"
        )

        fix_label_p = st.selectbox(
            "–°–ø–æ—Å–æ–± —Ñ–∏–∫—Å–∞—Ü–∏–∏ –∏–º–ø–ª–∞–Ω—Ç–∞—Ç–∞",
            options=["–ì–µ—Ä–Ω–∏–æ—Å—Ç–µ–ø–ª–µ—Ä", "–ö–ª–µ–π", "–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π"],
            key="p_fix"
        )

        prior_hernia_p = st.checkbox(
            "–ì—Ä—ã–∂–µ—Å–µ—á–µ–Ω–∏–µ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ (—Ä–µ—Ü–∏–¥–∏–≤–Ω–∞—è –≥—Ä—ã–∂–∞)",
            key="p_prior_hernia"
        )

    with c2:
        bmi_p = st.number_input(
            "–ò–ú–¢, –∫–≥/–º¬≤",
            min_value=10.0,
            max_value=70.0,
            step=0.1,
            value=26.0,
            key="p_bmi"
        )

    score_pain = pain_risk_score(
        surg_type=surg_label_p,
        fix_type=fix_label_p,
        bmi=bmi_p,
        prior_hernia=prior_hernia_p
    )
    cat_pain = pain_risk_category(score_pain)

    st.write("---")
    st.markdown(f"**–°—É–º–º–∞—Ä–Ω—ã–π –±–∞–ª–ª –ø–æ —à–∫–∞–ª–µ –±–æ–ª–∏:** {score_pain}")
    st.markdown(f"**–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∏—Å–∫–∞ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–π –±–æ–ª–∏:** {cat_pain}")

    if cat_pain == 

